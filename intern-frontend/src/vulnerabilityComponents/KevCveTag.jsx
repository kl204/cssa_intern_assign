import React, { useEffect, useMemo, useState } from "react";
import {
  Box,
  Typography,
  Modal,
  Backdrop,
  Fade,
  IconButton,
  Divider,
  Link,
} from "@mui/material";
import CloseIcon from "@mui/icons-material/Close";
import cisa_logo from "../assets/images/vul_page/cisa_logo.png";

/** ---- KEV 싱글톤 로더 (모듈 스코프: 앱 전체에서 1회만 네트워크 호출) ---- */
let KEV_DATA = null; // Array | null
let KEV_PROMISE = null; // Promise | null

function loadKevOnce() {
  if (KEV_DATA) return Promise.resolve(KEV_DATA);
  if (KEV_PROMISE) return KEV_PROMISE; // 동시 호출 디듀프

  KEV_PROMISE = fetch("/known_exploited_vulnerabilities.json")
    .then((r) => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then((json) => {
      KEV_DATA = Array.isArray(json?.vulnerabilities)
        ? json.vulnerabilities
        : [];
      return KEV_DATA;
    })
    .finally(() => {
      KEV_PROMISE = null;
    });

  return KEV_PROMISE;
}

const KevCveTag = ({ cveId }) => {
  const [kevReady, setKevReady] = useState(!!KEV_DATA);
  const [error, setError] = useState(null);
  const [open, setOpen] = useState(false);

  const handleOpen = () => setOpen(true);
  const handleClose = () => setOpen(false);

  /** 최초 1회만 로드. 이미 로드됐으면 바로 ready 처리 */
  useEffect(() => {
    let alive = true;
    if (KEV_DATA) {
      setKevReady(true);
      return;
    }
    loadKevOnce()
      .then(() => alive && setKevReady(true))
      .catch((e) => alive && setError("Failed to load KEV data."));
    return () => {
      alive = false;
    };
  }, []);

  /** cveId 매칭 (메모이즈) */
  const match = useMemo(() => {
    const id = cveId?.trim().toLowerCase();
    if (!kevReady || !id) return null;
    return KEV_DATA?.find((item) => item.cveID?.toLowerCase() === id) || null;
  }, [kevReady, cveId]);

  const kevExists = !!match;

  if (error) {
    return (
      <Typography variant="body2" color="error">
        {error}
      </Typography>
    );
  }

  return (
    <>
      <Box
        sx={{
          display: "inline-flex",
          alignItems: "center",
          gap: 1,
          px: 1.5,
          py: 0.5,
          borderRadius: "12px",
          fontSize: "13px",
          fontWeight: "bold",
          color: "#fff",
          backgroundColor: kevExists ? "#d32f2f" : "#9e9e9e",
          cursor: kevExists ? "pointer" : "default",
        }}
        onClick={kevExists ? handleOpen : undefined}
      >
        {kevExists ? "Critical" : "None"}
      </Box>

      <Modal
        open={open}
        onClose={handleClose}
        closeAfterTransition
        slots={{ backdrop: Backdrop }}
        slotProps={{ backdrop: { timeout: 500 } }}
      >
        <Fade in={open}>
          <Box
            sx={{
              position: "absolute",
              top: "50%",
              left: "50%",
              transform: "translate(-50%, -50%)",
              bgcolor: "background.paper",
              borderRadius: 3,
              boxShadow: 24,
              p: 4,
              maxWidth: 700,
              width: "95%",
            }}
          >
            <IconButton
              onClick={handleClose}
              sx={{
                position: "absolute",
                top: 8,
                right: 8,
                color: (theme) => theme.palette.grey[500],
              }}
            >
              <CloseIcon />
            </IconButton>

            {/* Header */}
            <Box sx={{ display: "flex", flexDirection: "column", mb: 2 }}>
              <Box
                component="img"
                src={cisa_logo}
                alt="cisa_logo"
                onClick={() =>
                  window.open(
                    "https://www.cisa.gov/known-exploited-vulnerabilities-catalog",
                    "_blank",
                    "noopener,noreferrer"
                  )
                }
                sx={{
                  width: "100%",
                  height: 100,
                  objectFit: "contain",
                  mb: 2,
                  cursor: "pointer",
                }}
              />

              <Box>
                <Box
                  sx={{
                    display: "inline-flex",
                    alignItems: "center",
                    gap: 1,
                    px: 1.5,
                    py: 0.5,
                    borderRadius: "12px",
                    fontSize: "13px",
                    fontWeight: "bold",
                    color: "#fff",
                    backgroundColor: kevExists ? "#d32f2f" : "#9e9e9e",
                  }}
                >
                  {kevExists ? "Critical" : "None"}
                </Box>
                <Typography variant="h6" fontWeight="bold">
                  {cveId}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  (KEV) Known Exploited Vulnerability — maintained by CISA
                </Typography>
              </Box>
            </Box>

            <Divider sx={{ mb: 2 }} />

            {/* Content */}
            {match ? (
              <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                <Typography variant="body2">
                  <strong>Description:</strong>{" "}
                  {match.shortDescription || "N/A"}
                </Typography>

                <Typography variant="body2">
                  <strong>CVE Details:</strong>{" "}
                  {match.notes ? (
                    <Link
                      href={match.notes}
                      target="_blank"
                      rel="noopener noreferrer"
                      underline="hover"
                    >
                      {match.notes}
                    </Link>
                  ) : (
                    "N/A"
                  )}
                </Typography>

                <Typography variant="body2">
                  <strong>Vendor:</strong> {match.vendorProject || "N/A"}
                </Typography>

                <Typography variant="body2">
                  <strong>Product:</strong> {match.product || "N/A"}
                </Typography>

                <Typography variant="body2">
                  <strong>Vulnerability Name:</strong>{" "}
                  {match.vulnerabilityName || "N/A"}
                </Typography>

                <Typography variant="body2">
                  <strong>Required Action:</strong>{" "}
                  {match.requiredAction || "N/A"}
                </Typography>

                <Typography variant="body2">
                  <strong>Ransomware Campaign Use:</strong>{" "}
                  {match.knownRansomwareCampaignUse || "N/A"}
                </Typography>

                <Typography variant="body2">
                  <strong>Date Added:</strong> {match.dateAdded || "N/A"}
                </Typography>
              </Box>
            ) : (
              <Typography variant="body2">
                {kevReady ? "No additional data found." : "Loading..."}
              </Typography>
            )}
          </Box>
        </Fade>
      </Modal>
    </>
  );
};

export default KevCveTag;
