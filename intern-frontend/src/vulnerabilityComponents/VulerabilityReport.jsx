import React, { useState, useEffect, useRef } from "react";
import { Typography, Stack, Box, Button } from "@mui/material";

import KeyboardArrowRightIcon from "@mui/icons-material/KeyboardArrowRight";
import KeyboardArrowDownIcon from "@mui/icons-material/KeyboardArrowDown";

import useStepStore from "../stores/useStepStore";
import useVulStore from "../stores/useVulStore";
import RankOfVulTableComponent from "../utils/RankOfVulTableComponent";
import RankOfCVETableComponent from "../utils/RankOfCVETableComponent";
import RankOfVomTableComponent from "../utils/RankOfVomTableComponent";
import VomCveTableComponent from "../utils/VomCveTableComponent";
import VulnerabilityTableComponent from "./VulnerabilityTableComponent";
import VulnerabilityCharts from "./VulnerabilityCharts";

import useVexStore from "../stores/useVexStore";

const VulnerabilityReport = () => {
  const [showCharts, setShowCharts] = useState(true); // ğŸ”¹ ì°¨íŠ¸ í‘œì‹œ ì—¬ë¶€
  const chartsRef = useRef(null); // ğŸ”¹ ë“œë¡­ë‹¤ìš´ ì„¹ì…˜ ì°¸ì¡°

  const { increase } = useStepStore();
  const { response, vomResponse, vexReturn } = useVulStore();
  const { vexLock } = useVexStore();

  useEffect(() => {
    console.log("response : ", JSON.stringify(response.total_number, null, 2));
  }, [response]);

  if (!response) {
    return <Typography>Try again with the SBOM process</Typography>;
  }

  // âœ… ì°¨íŠ¸ ìƒíƒœ í† ê¸€ í•¨ìˆ˜
  const toggleCharts = () => {
    setShowCharts((prev) => {
      const newState = !prev;

      // ğŸ”¹ ìƒˆë¡œìš´ ìƒíƒœê°€ true(í¼ì³ì§)ë¼ë©´, í•´ë‹¹ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      if (newState) {
        setTimeout(() => {
          chartsRef.current?.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }, 100); // ì• ë‹ˆë©”ì´ì…˜ ë¶€ë“œëŸ½ê²Œ ì ìš©
      }

      return newState;
    });
  };

  const continueVex = () => {
    if (!vexReturn) {
      alert(
        "Vulnerability analysis has not completed yet. Please try again after it finishes."
      );
      return;
    }

    if (!vexReturn?.raw_data?.length && !vexLock) {
      const proceed = window.confirm(
        "No CVEs have been selected. Do you still want to proceed?"
      );
      if (proceed) {
        increase();
      }
    } else {
      increase();
    }
  };

  return (
    <>
      <Box
        sx={{
          display: "flex",
          flexDirection: "row",
          justifyContent: "space-between",
        }}
      >
        <Typography
          variant="h4"
          sx={{
            textAlign: "left",
            my: "10px",
            color: "rgb(139, 53, 53)",
            fontWeight: "bold",
          }}
        >
          Vulnerability
        </Typography>
        <Button
          variant="contained"
          onClick={continueVex}
          sx={{
            width: "100px",
            height: "50px",
            color: "white",
            backgroundColor: "rgba(153, 48, 48, 1)",
            textTransform: "none", // ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ìœ ì§€
            "&:hover": {
              backgroundColor: "rgba(121, 22, 22, 1)", // ì£¼í™©ìƒ‰ hover ë°°ê²½
              borderColor: "orange",
            },
            fontSize: "1.5rem",
          }}
        >
          Next
        </Button>
      </Box>

      {/* ----------------------------- íƒ€ì´í‹€--------------------------------------------- */}
      <Typography variant="h6" sx={{ textAlign: "left" }}>
        Detected {response.total_number} vulnerable code clones (
        {response.total_cve_number} kinds of CVE) in your package.
      </Typography>

      {/* ----------------------------- ë­í¬ í…Œì´ë¸” ì„¹ì…˜ --------------------------------------------- */}

      <Stack spacing={3} direction={{ xs: "column", md: "row" }}>
        <RankOfVulTableComponent response={response} />
        <RankOfCVETableComponent response={response} />
        {/* <RankOfVomTableComponent response={vomResponse} /> */}
      </Stack>

      {/* ----------------------------- íŠ¸ë¦¬ & ë…¸ë“œ ì„ íƒ í…Œì´ë¸” ì„¹ì…˜ --------------------------------------- */}
      <VulnerabilityTableComponent />

      {/* ----------------------------- íŒŒì´ì°¨íŠ¸/ë°”ì°¨íŠ¸ ì„¹ì…˜ --------------------------------------- */}
      <Box
        sx={{
          textAlign: "left",
          display: "flex",
          alignItems: "center",
          cursor: "pointer",
        }}
        onClick={toggleCharts}
      >
        {showCharts ? (
          <KeyboardArrowDownIcon sx={{ transition: "0.3s" }} />
        ) : (
          <KeyboardArrowRightIcon sx={{ transition: "0.3s" }} />
        )}

        <Typography
          variant="h6"
          sx={{
            padding: "5px 10px",
            fontSize: "16px",
            fontWeight: "bold",
          }}
        >
          {showCharts
            ? "Hide Charts"
            : "The charts below summarize CVE distribution, CVSS severity, and CWE weakness types."}
        </Typography>
      </Box>

      {showCharts && (
        <Box ref={chartsRef}>
          <VulnerabilityCharts response={response} />
        </Box>
      )}

      {/* í˜„ì¬ëŠ” vomìœ¼ë¡œ vexë¥¼ ì§„í–‰ì€ ëª»í•¨ */}
      {/* <VomCveTableComponent /> */}
    </>
  );
};

export default VulnerabilityReport;
