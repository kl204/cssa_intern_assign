import React, { useEffect } from "react";
import {
  Typography,
  Card,
  CardContent,
  CircularProgress,
  Box,
} from "@mui/material";

import VulnerabilityReport from "./VulerabilityReport";

import useVulStore from "../stores/useVulStore";
import useVexStore from "../stores/useVexStore";

import vulResponse from "../assets/vul_json/vul_response.json";

const VulnerabilityComponent = () => {
  const { response, setResponse, vomResponse } = useVulStore();
  const { setFinishAnalysis, vexLock } = useVexStore();

  /* VEX Lock 처리 */
  useEffect(() => {
    if (!vexLock) {
      setFinishAnalysis(false);
    }
  }, [vexLock, setFinishAnalysis]);

  /* ✅ 최초 마운트 시 mock response 세팅 */
  useEffect(() => {
    if (!response) {
      setResponse(vulResponse);
      // console.log("response check: ", JSON.stringify(vulResponse, null, 2));
    }
  }, [response, setResponse]);

  const isLoading = !response && !vomResponse;

  return (
    <Card
      sx={{
        borderRadius: 2,
        boxShadow: 3,
        backgroundColor: "#fff",
        p: 3,
        border: "1px solid rgba(147, 147, 147, 1)",
      }}
    >
      <CardContent sx={{ padding: 0 }}>
        {isLoading ? (
          <Box
            sx={{
              textAlign: "center",
              mt: 5,
              border: "1px solid",
              borderColor: "gray",
              borderRadius: "10px",
              height: "200px",
              display: "flex",
              flexDirection: "column",
              justifyContent: "center",
              alignItems: "center",
            }}
          >
            <CircularProgress />
            <Typography variant="h6" mt={2}>
              Processing your file, please wait...
            </Typography>
          </Box>
        ) : (
          <VulnerabilityReport />
        )}
      </CardContent>
    </Card>
  );
};

export default VulnerabilityComponent;
